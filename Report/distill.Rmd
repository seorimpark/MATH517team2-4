---
title: "Brazilian Aeronautics Accidents"
description: |
  Statistical computation and visualization (MATH-517)
date: December 24, 2021
author:
- name: "Zineb AGNAOU"  
  url: https://github.com/ZinebAg
- name: "Fahim BECK"
  url: https://github.com/FahimBeck
- name: "Yiren CAO"
  url: https://github.com/yirencao
- name: "Matias JANVIN"
  url: https://github.com/matiasjanvin
- name: "Salima JAOUA"
  url: https://github.com/salimajaoua
- name: "Seorim PARK"
  url: https://github.com/seorimpark
output: distill::distill_article
bibliography: bibliography.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-annotated-bibliography.csl
nocite: '@*'
---

<div style="text-align: justify">
<div style="text-justify: inter-word">

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = "allow")
```

## Introduction

Modern society has been become increasingly dependent on the use of airplanes during the past decades. Despite the impressive engineering feat that aviation represents, airplanes and other aircraft sometimes fail, occasionally fatally. Understanding the causes of failure and considering what can be done to address these is of crucial interest for regulatory bodies and aviation authorities, but also for passengers. In the following dataset, we consider an extensive collection of incidents involving aircraft of different types across Brazil in the period of time 2006-2015. Various data have been collected for each incident. In what follows, we set out to investigate common features of these aircraft incidents.

### Research questions

The main issue is to understand the factors that favor a plane crash, especially in Brazil in a 10-year period. Similarities between the accidents will be sought. Perhaps would it be possible to identify risk factors thereby improving passenger safety? 

Here are some more specific questions arising from the main problem that we will try to answer: 

- How are the accidents distributed on a map? Are there areas where accidents are more concentrated? 

- How do the accidents evolve through time? Is the occurrence rate constant? Are there periods with more accidents, i.e. during school vacation, summer? Do they happen at a certain time of the day?

- Does the age of the aircraft play a role? Are old planes more prone to accidents? 

- What about the characteristics of the aircraft? Is the model, the mass or the number of engines take a part in causing a crash?

- What are the main occurrence types or cause of accidents? 

- What can we say about damage severity of the accidents? Are there correlations?

### Approaches

We employed linear, logistic and quantile regression to investigate the association between aircraft lifetime, accident severity and damage level.


## Sources of information / datasets



````{r packages, include=FALSE}
library(ggplot2)
library(geobr)
library(tidyr)
library(dplyr)
library(corrplot)
library(stargazer)
library(cowplot)
library(snakecase)
library(stringi)
library(stringr)
library(leaflet)
library(readr)
library(quantreg)
library(latex2exp)
library(lubridate)
````

```{r,include=FALSE}
tex2markdown <- function(texstring) {
  writeLines(text = texstring,
             con = myfile <- tempfile(fileext = ".tex"))
  texfile <- pandoc(input = myfile, format = "html")
  cat(readLines(texfile), sep = "\n")
  unlink(c(myfile, texfile))}
```


## Exploratory data analysis
```{r, include=FALSE}
# loading the data
#data=read.csv("~/Desktop/Github/SCV/SCV_project/MATH517team2-4/MATH517team2-4/Data/aircrafts_occurrences_merged.csv")
data = read.csv("../Data/aircrafts_occurrences_merged.csv")
```

```{r,include=FALSE}
#dealing with the NA
na_count <-sapply(data, function(y) sum(length(which(is.na(y)))))
na_count
```

```{r,include=FALSE}
data_wo_na=drop_na(data)
```

```{r ,  results='asis', echo=FALSE}
stargazer(na_count, type = "html", title = "Table 1: Repartition of NAs in the columns")
```

The dataset is full of missing values to the point where there is no complete row. The Table (1) displays the number of missing values in each column. $Takeoff$ is the top column containing NAs, with more than 87.4% of the data missing. We see also a significant number of missing data points in the columns related to the report such as $report_number$ with more than 78.6%, $published_report$,$publication_day$ and $publication_Week$ with 51%. We can see that the data is most present for columns containing information that are independent of the accident such as $aircraft_id$, $manufacturer$ and $type_operation$.

```{r, include=FALSE}
table(data["equipment"])/(2043-1)
```

When looking at the type of equipment, 78% of our data concerns airplanes. It is followed by helicopter that constitue a little less that 13% of the data. Then comes ultralight, a bit more than 7% of the dataset. The rest are airship, amphibious our unknown.

```{r, include=FALSE}
unique(data["manufacturer"])
```
```{r, include=FALSE}
table(data["manufacturer"])
```
There are 120 unique manufacturers represented in our dataset. The top three manufacturers are the following: $NEIVA INDUSTRIA AERONAUTICA, EMBRAER and AERO BOERO$ with respectively 388, 155 and 126 planes. 

```{r, include=FALSE}
table(data$engine_type)/2043
```
78% of the planes present in the dataset use a $ PISTON$ engine. 7% use $TURBOSHAF$ engine, 6.8% use $TURBOPROP$ and the rest $JET$, $WITHOUT TRACTION$ or unknown engines.

```{r NbrEng, fig.cap="Distribution of the number of engines",echo=FALSE}
hist(data$engines_amount,main="Distribution of the number of engines.", xlab="Number of engines")

```

```{r,include=FALSE}
table(data$engines_amount)/(2043-9)
```
Considering Figure \@ref(fig:NbrEng), 73.25% of planes use a single engine. 24% of planes use two engines. The rest of planes have either 3 or 4 engines. We believe that 0 refers to unknown data although there was no mention of it in the data description.


```{r distWeight,fig.cap="Distribution of take off max weight (in Lbs)", echo=FALSE}
data_weight_no_zero=data
data_weight_no_zero=data_weight_no_zero[data_weight_no_zero$takeoff_max_weight..Lbs. != 0,]
hist(data_weight_no_zero$takeoff_max_weight..Lbs., main="Distribution of take off max weight (in Lbs)", xlab='Lbs', breaks =50)
```
```{r,include=FALSE}
max(data_weight_no_zero$takeoff_max_weight..Lbs.)
```
Figure \@ref(fig:distWeight) is displayed the distribution of take off max weight (in Lbs). It can be seen that that the mean weight is of 11,919.2 Lbs (5,406.4 Kg). There are though very strong outliers with planes having set their maximun weight at 630,499 Lbs (285,989.5 Kg). 

```{r distManYear,fig.cap="Distribution of manufacturing year",echo=FALSE}
data_year_no_zero=data
data_year_no_zero=data_year_no_zero[data_year_no_zero$year_manufacture != 0,]
hist(data_year_no_zero$year_manufacture,breaks=100, main="Distribution of manufacturing year", xlab="Year")
```
In Figure \@ref(fig:distManYear) is displayed the distribution of manufacturing year. One can observe that the planes represented in the dataset were manufactered between 1936 and 2015. The year distribution is trimodal with high peaks in late 70s, early 90s and mid 00s. 

```{r, include= FALSE}
table(data$registration_country)
```

Concerning the registration country, 2000 out of the 2043 constituting the data are registered in Brazil. 22 are registered in the United States of America and finally there is one accident registered in Germany, France, Poland, Russia, Saudia Arabia, South Africa, Spain and Uruguay. 

```{r, include= FALSE}
table(data$registration_aviation)/(2043)
```
37% of the accident concern $private$ registrations. 18% come from $instruction$ registration. The rest are either $aerotaxi$ (13%),$experimental$ (9.8%), $agricultural$ (9%), $regular$ (4%), $specialized$ (3%) or other registrations. 


```{r, include= FALSE}
sort(table(data$operation_phase)/2043)
```
19% of the accidents registered happened when landing. 17% when taking off. 11% when cruising and 9% during the run after the landing. Accidents also happen during the following phases: during maneuver (4.9%), during ascension(4.8%), final approximation (3.4%), descend (3.3%), low altitude navigation (2.8%), traffic circuit (2.5%), taxi (2%), rush on the ground (1.4%) and other less represented phases.

```{r, include= FALSE}
sort(table(data$damage_level)/2043)
```
```{r, include= FALSE}
table(data$classification)/2043
```
Concerning the damage, 72.6% of crashes were classified as $accident$ and the rest was classified as $serious incident$. 58% of the planes knew substantial damage after the crash. 17% are completely destroyed, 12.7% know light damage where 8% have no damage. The rest is unknown. 


```{r distFat,fig.cap="Distribution of fatalities",echo=FALSE}
hist(data$fatalities_amount, breaks=50, main= "Distribution of fatalities", xlab="fatalities")
```
In Figure \@ref(fig:distFat) is displayed the number the fatalities. It can be seen that most of the crashes involve less than 20 deaths. The deadliest crash was in a private helicopter in 1999 in Sau Paolo where 199 lost their life during the landing. 


```{r, include=FALSE}
table(data$investigation_status)/2043
```
Finally, the investigation of 52% of the crashes is finished. 37% are in progress and less than 0.05% of the crashes have had their investigation reopened. 

## Geographical visualization of accidents 

```{r, include=FALSE}

data = read.csv("../Data/aircrafts_occurrences_merged.csv")

# Select needed variables
data = data[, c("localization", "fu", "country", "aerodrome", "origin_flight", 
                "destination_flight", "registration_country", "classification", 
                "registration", "manufacturer", "model", "operation_phase", 
                "damage_level", "type.of.occurrence", "occurrence_day", "time")]

# Formatting
data$classification = tolower(data$classification)
data$manufacturer[data$manufacturer == "***"] = "unknown"
data$model[data$model == "***"] = "unknown"
data$operation_phase = tolower(data$operation_phase)
data$operation_phase[data$operation_phase == ""]  = "unknown"
data$damage_level = tolower(data$damage_level)
data$type.of.occurrence = tolower(data$type.of.occurrence)


#### Accidents per state ####

# Brazil states
brazil_fu = data[data$fu != "***" & data$fu != "EX",]

# Accidents per state
brazil_fu = data.frame(table(brazil_fu$fu))
colnames(brazil_fu) = c("fu", "accidents")

# Brazilian states
#states <- read_state(year=2019)
states <- readRDS("states.rds")

# Join the databases
states <- dplyr::left_join(states, brazil_fu, by = c("abbrev_state" = "fu"))
states$accidents[is.na(states$accidents)] = 0

# Map
labels <- sprintf(
  "<strong>%s</strong><br/>%g accidents",
  states$name_state, states$accidents
) %>% lapply(htmltools::HTML)

bins <- seq(0,500,100)
pal <- colorBin("YlOrRd", domain = states$accidents, bins = bins)

fu <- leaflet(states) %>% addTiles() %>% addPolygons(
  fillColor = ~pal(accidents),
  weight = 1,
  opacity = 1,
  color = "grey",
  dashArray = "3",
  fillOpacity = 0.4, 
  layerId = ~geom,
  highlightOptions = highlightOptions(
    weight = 3,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.6,
    bringToFront = TRUE),
  label = labels,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>%
  addLegend(pal = pal, values = ~accidents, opacity = 0.7, title = "Accidents",
            position = "bottomright")

# External accidents + NAs
external = t(data.frame(table(data[data$fu == "***" | data$fu == "EX", "country"])))
rownames(external) = c("Countries", "Accidents")
#stargazer(external)

# Preparing data before geolocating
brazil = data[data$fu != "***" & data$fu != "EX" & data$localization != "NÃO IDENTIFICADA",]

# Loading coordinates
table = readRDS(file = "localization.rds")

# Adding location
brazil$localization = to_title_case(brazil$localization)
n = length(brazil$localization)
loc = 0

for (i in 1:n) {
  loc = rbind(loc, table[table$names==brazil$localization[i], c("lon", "lat")])
}

brazil = cbind(brazil, loc[-1,])

# Label + popup
label <- sprintf("%s<br/>%s<br/>%s<br/>%s",
                  brazil$model,
                  brazil$classification,
                  brazil$occurrence_day,
                  brazil$localization
                  ) %>% lapply(htmltools::HTML)

popup <- paste(sep = "<br/>", 
               paste("Model:", brazil$model),
               paste("Manufacturer:", brazil$manufacturer),
               paste("Registration:", brazil$registration),
               paste("Classification:", brazil$classification),
               paste("Damage level:", brazil$damage_level),
               paste("Operation phase:", brazil$operation_phase),
               paste("Type of occurrence:", brazil$type.of.occurrence),
               paste("Occurrence date:", brazil$occurrence_day),
               paste("Occurrence time:", brazil$time)
               )

# Map
cluster <- leaflet(data = brazil) %>% addTiles() %>% 
  addMarkers(~lon, ~lat, popup = popup, label = label, clusterOptions = markerClusterOptions())

# Cities with most accidents
cities = t(data.frame(sort(table(brazil$localization), decreasing = TRUE)[1:10]))
rownames(cities) = c("Cities", "Accidents")
#stargazer(cities)

```

This section is devoted to the study of the places where aircraft accidents occur. Indeed, it is essential to understand where they occur in order to identify more risk factors.

First, a comparison between the Brazilian states allows us to draw a first conclusion (Figure \@ref(fig:states)). Note that accidents are cumulative over the 10-year period. 

```{r states, fig.cap="Number of accidents from 2006 to 2015 by state in Brazil", echo=FALSE}

fu

```

All the states have less than 200 accidents, more precisely less than 170 (Rio Grande do Sul), except one state: São Paulo. This state is not larger than the others (it is rather medium in size), which indicates that there is clearly a concentration of accidents in this area. Note that ten accidents are not shown on the map Table (2). Eight of them occurred outside of Brazil and two more for other reasons: one ended up in international waters and the other does not have its location identified. 

```{r , results='asis', echo=FALSE}

stargazer(external, type = "html", title = "Table 2: Accidents not reprensented on the previous map by country")

```

An explanation for this observation is linked in particular to demography. Indeed, the state of São Paulo is the most populous in Brazil with more than 41 million inhabitants in 2010 [@population]. Air traffic is therefore concentrated there, especially since the largest airports of the country are located in this state (for example São Paulo Guarulhos International Airport and São Paulo Congonhas Airport). The risk of accidents is therefore higher. 

To be more precise in the geographical approach, it is possible to establish a map according to the location of the accident (nearest city). As the geographic coordinates are not included in the data, it is possible to use geocoding given that the city is available. For this, we used two packages: `ggmap` and `Nominatim`. An API key is required to geocode for each package ([Google Maps](https://mapsplatform.google.com) for `ggmap` and [MapQuest](https://developer.mapquest.com) for `Nominatim`). As the locations are quite precise, there are often errors in the coordinates returned by geocoding, which is why we used two packages by selecting the most reasonable coordinates. It is still possible to have some deviations between the city and the place shown on the map, but the latter should not be greater than a degree of longitude and latitude. 

In Figure \@ref(fig:location), accidents are represented in clusters which are scattered by zooming. For each accident, information is available such as the model, the manufacturer, the date or the time. Note that 11 more accidents have been removed compared to the last map. The reason is that the location has not been identified. 

```{r location, fig.cap="Number of accidents from 2006 to 2015 clustered by location in Brazil", echo=FALSE}

cluster

```

We still notice the same thing, that is to say a concentration of accidents in the Southeast Region of Brazil. This is explained by the fact that the traffic there is the most dense, as this article confirms in particular [@airtraffic]. It turns out that some cities are noteworthy in terms of the number of accidents. Table (3) represents the ten cities with the most accidents. 

```{r, results='asis', echo=FALSE}

stargazer(cities, type = "html", title = "Table 3: Top ten cities with the highest number of accidents")

```

A demographic explanation is still reasonable. The first six cities in Table (3) are among the ten most populous cities in Brazil [@cities]. Moreover, they also have airports on the list of the 20 busiest airports in Brazil [@airports]. 

Looking more closely at the accidents in these cities, we see that all kinds of aircraft are represented, whether they are airliners, tourist planes or even helicopters. To learn more in this direction, it is possible to explore the accidents on the map (Figure \@ref(fig:location)). 


## Time analysis: 

###Visualisation:
```{r, include=FALSE}
data = read_csv("../Data/aircrafts_occurrences_merged.csv") 

data$occuranceWeek <- as.Date(data$occurrence_day)
data$occuranceWeek <-wday(data$occuranceWeek, label=TRUE)

data$publicationWeek <- as.Date(data$publication_day)
data$publicationWeek <-wday(data$publicationWeek, label=TRUE)
```

```{r, include=FALSE}
data$occuranceWeek <- as.Date(data$occurrence_day)
```

```{r hourAccid, fig.cap="Distribution of Accidents throughout the hours of the day", echo=FALSE}
hist(strptime(data$time, format="%H:%M:%S"),main="Distribution of Accidents throughout the hours of the day",xlab="Hours of the day",breaks="hours")
```
In Figure \@ref(fig:hourAccid) are displayed the distribution of accidents throughout the hours of the day. The distribution is bimodal and it can be observed that most of the crashes happen either 2pm or 8pm.

```{r timeAccid, fig.cap="Distribution of Accidents throughout days",  echo=FALSE}
hist(data$occurrence_day,main="Distribution of Accidents throughout days",xlab="Days",breaks='months')
```
In Figure \@ref(fig:timeAccid) are displayed the distribution of accidents throughout days. we can see that there is an increasing trend. 

```{r, include=FALSE}
Time_Occurence_publication=data$publication_day-data$occurrence_day
Time_Occurence_publication=as.numeric(Time_Occurence_publication, units="days")
```

```{r Occurancepublication, fig.cap="of time difference between the occurance and the publication date",echo=FALSE}
hist(Time_Occurence_publication,main="Distribution of time difference: occurance and publication",xlab="Number of days")
```
In Figure \@ref(fig:Occurancepublication) are displayed the distribution of time difference in days between the occurance day and publication day. It can be seen that most of crashes are reported the same year. The longest time difference is of 3589 days. It was for a political operation caused by a loss of control in the air in year 1986 in Brazil. 

###Lifetime of aircraft:

```{r include=FALSE}
df.age <- read_csv("../Data/aircrafts_occurrences_merged.csv")
```

In this section, we consider whether there is any association between the age of an aircraft and the severity and damage level of the incident. To begin, we have plotted the cumulative distribution function of the aircrafts' age in Figure \@ref(fig:ageCDF) below.

```{r echo=FALSE}
# Setting categorical variables to factors and removing missing values

# Removing rows with missing or 0 value for the year of manufacture
df.age<-df.age[df.age$year_manufacture!=0 & !is.na(df.age$year_manufacture),]

# Extracting the year of occurrence
df.age$occurrence_day<-as.numeric(format(df.age$occurrence_day, format="%Y"))

df.age$lifetime<-df.age$occurrence_day-df.age$year_manufacture


# Plotting cumulative distribution functions
# plot(ecdf(df.age$occurrence_day))
# plot(ecdf(df.age$year_manufacture))



# First, we assign a numerical value to each damage level, and remove rows with unknown damage level

df.damage.age<-df.age[df.age$damage_level!='UNKNOWN',]
df.damage.age$damage_level[df.damage.age$damage_level=='NONE']<-0
df.damage.age$damage_level[df.damage.age$damage_level=='LIGHT']<-1
df.damage.age$damage_level[df.damage.age$damage_level=='SUBSTANTIAL']<-2
df.damage.age$damage_level[df.damage.age$damage_level=='DESTROYED']<-3
df.damage.age$damage_level<-as.numeric(df.damage.age$damage_level)

# Assign values 0 to incidents classified as 'accident', and 1 to incidents classified as serious incident
df.damage.age$classification[df.damage.age$classification=='ACCIDENT']<-0
df.damage.age$classification[df.damage.age$classification=="SERIOUS INCIDENT"]<-1
df.damage.age$classification<-as.numeric(df.damage.age$classification)

# Set aircraft type as factor, and remove NA rows
df.damage.age$equipment<-as.factor(df.damage.age$equipment)
df.damage.age<-df.damage.age[!is.na(df.damage.age$equipment),]
```

```{r ageCDF, fig.cap="Cumulative distribution function of the aircraft's lifetime, denoted by $X$", echo=FALSE}
plot( ecdf(df.age$lifetime), main='', ylab =TeX('$P(X \\leq x)$') )
```

We observe that more than 80% of the aircraft are between 0 and 40 years old at the time of the incident, with a small number of aircraft reaching nearly 80 years.

Next, we provide a scatter plot to visually inspect the association between age and damage level in (\@ref(fig:damagelifetime))

```{r damagelifetime, fig.cap="Scatter plot of damage level (coded on a 0-3 scale) versus aircraft lifetime in recorded incidents", echo=FALSE}
plot(df.damage.age$lifetime, df.damage.age$damage_level, 'p', xlab='Aircraft lifetime',ylab='Damage level')
```

and likewise between aircraft lifetime damage level (outcome)  in (\@ref(fig:damageseverity))

```{r damageseverity, fig.cap="Scatter plot of severity versus aircraft lifetime in recorded incidents", echo=FALSE}
plot(df.damage.age$lifetime, df.damage.age$classification, 'p', xlab='Aircraft lifetime', ylab='accident severity')
```

To investigate the marginal association between age and damage level we perform regression analysis using a linear model, logistic model in addition to quantile regression. 

The fit diagnostic for the linear regression of damage level on lifetime of the plane gives

```{r echo=FALSE}
fit.linear<-lm(df.damage.age$damage_level ~ df.damage.age$lifetime)
summary(fit.linear)
```

Here, we have coded the damage level on a scale of 0 to 3. Furthermore, the confidence interval is given by

```{r echo=FALSE}
cbind(beta = coef(fit.linear), confint(fit.linear))
```

which is small and includes the null value of the slope. 

Likewise, the logistic regression of aircraft lifetime on severity (with corresponding confidence intervals) is given below:

```{r echo=FALSE}
fit.logistic <-glm(classification ~ lifetime, data = df.damage.age, family = "binomial")
summary(fit.logistic)
exp(coef(fit.logistic))
exp(cbind(OR = coef(fit.logistic), confint(fit.logistic)))
```

Once again, the confidence interval includes the null value. Finally, we consider the quantile regression coefficient from the quantile regression model
$$ Q_Y(\tau\mid X) = a_0(\tau) + b_0(\tau)X $$
where the outcome $Y$ is airplane lifetime and we take accident severity as an exposure $X$. The resulting regression coefficient is plotted in Figure (\@ref(fig:quantilelifetime))

```{r quantilelifetime, fig.cap="Quantile regression of damage level on the quantile of aircraft lifetime", echo=FALSE}
# Quantile regression for severity
fm2 <- rq(lifetime ~ classification, data = df.damage.age, tau =  0.1+ 1:8/10)
plot(fm2, parm = 2, mar = c(5.1, 4.1, 2.1, 2.1), xlab=TeX('$\\tau$'),main='Y = Lifetime, X = Damage level', ylab = TeX('$b_0(\\tau$)'), cex = 1, pch = 19)
```

The quantile plot shows that the conditional cumulative distribution function, conditioning on severity level 'serious incident', is narrower compared to the conditional cumulative distribution function, conditioning on severity level 'accident'. In other words, both high and low quantiles are shifted towards the median.

As we did not find any strong associations between damage level and age of the aircraft marginally in the population. This motivated us to examine further whether such associations could exist within subsets of the population, such as the strata of incidents involving helicopters. Once again, we perform a logistic regression, which yields the following fit diagnostic and confidence intervals:

```{r echo=FALSE}
df.helicopters<-df.damage.age[df.equipment='HELICOPTER',]
fit.logistic <-glm(classification ~ lifetime, data = df.helicopters, family = "binomial")
summary(fit.logistic)
exp(coef(fit.logistic))
exp(cbind(OR = coef(fit.logistic), confint(fit.logistic)))
```

We do not find a strong association between accident severity and aircraft age within the stratum of helicopters either (the confidence interval for the lifetime coefficient includes the null-value, and the p-value of the coefficient is 0.227).

## Conclusion

We employed linear, logistic and quantile regression to investigate the association between aircraft lifetime, accident severity and damage level, but did not find any statistically significant associations.

## Future improvements


<div id="refs"></div>


